// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

model TenantSequenceCounter {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  value     Int      @default(0)
  updatedAt DateTime @default(now()) @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name])
  @@index([tenantId])
}

model FixedAssetCategory {
  id                      String             @id @default(uuid())
  tenantId                String
  code                    String
  name                    String
  defaultMethod           DepreciationMethod @default(STRAIGHT_LINE)
  defaultUsefulLifeMonths Int
  defaultResidualRate     Decimal?           @db.Decimal(7, 4)
  assetAccountId          String
  accumDepAccountId       String
  depExpenseAccountId     String
  createdAt               DateTime           @default(now())

  tenant            Tenant  @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  assetAccount      Account @relation("FixedAssetCategoryAssetAccount", fields: [assetAccountId], references: [id], onDelete: Restrict)
  accumDepAccount   Account @relation("FixedAssetCategoryAccumDepAccount", fields: [accumDepAccountId], references: [id], onDelete: Restrict)
  depExpenseAccount Account @relation("FixedAssetCategoryDepExpenseAccount", fields: [depExpenseAccountId], references: [id], onDelete: Restrict)

  assets FixedAsset[]

  @@unique([tenantId, code])
  @@index([tenantId])
}

model FixedAsset {
  id                 String             @id @default(uuid())
  tenantId           String
  categoryId         String
  name               String
  description        String?
  createdById        String
  acquisitionDate    DateTime
  capitalizationDate DateTime?
  cost               Decimal            @db.Decimal(18, 2)
  residualValue      Decimal            @db.Decimal(18, 2)
  usefulLifeMonths   Int
  method             DepreciationMethod @default(STRAIGHT_LINE)
  status             FixedAssetStatus   @default(DRAFT)

  assetAccountId      String?
  accumDepAccountId   String?
  depExpenseAccountId String?

  vendorId    String?
  apInvoiceId String?

  capitalizationJournalId String?
  disposalJournalId       String?

  createdAt DateTime @default(now())

  tenant   Tenant             @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  createdBy User             @relation("FixedAssetCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  category FixedAssetCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  assetAccount      Account? @relation("FixedAssetAssetAccount", fields: [assetAccountId], references: [id], onDelete: Restrict)
  accumDepAccount   Account? @relation("FixedAssetAccumDepAccount", fields: [accumDepAccountId], references: [id], onDelete: Restrict)
  depExpenseAccount Account? @relation("FixedAssetDepExpenseAccount", fields: [depExpenseAccountId], references: [id], onDelete: Restrict)

  vendor    Supplier?        @relation(fields: [vendorId], references: [id], onDelete: Restrict)
  apInvoice SupplierInvoice? @relation(fields: [apInvoiceId], references: [id], onDelete: Restrict)

  capitalizationJournal JournalEntry? @relation("FixedAssetCapitalizationJournal", fields: [capitalizationJournalId], references: [id], onDelete: Restrict)
  disposalJournal       JournalEntry? @relation("FixedAssetDisposalJournal", fields: [disposalJournalId], references: [id], onDelete: Restrict)

  depreciationLines FixedAssetDepreciationLine[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([createdById])
  @@index([categoryId])
}

model FixedAssetDepreciationRun {
  id         String                          @id @default(uuid())
  tenantId   String
  periodId   String
  runDate    DateTime                        @default(now())
  postedById String
  status     FixedAssetDepreciationRunStatus @default(POSTED)

  journalEntryId String?

  tenant       Tenant           @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  period       AccountingPeriod @relation(fields: [periodId], references: [id], onDelete: Restrict)
  postedBy     User             @relation("FixedAssetDepreciationRunPostedBy", fields: [postedById], references: [id], onDelete: Restrict)
  journalEntry JournalEntry?    @relation("FixedAssetDepreciationRunJournal", fields: [journalEntryId], references: [id], onDelete: Restrict)

  lines FixedAssetDepreciationLine[]

  @@unique([tenantId, periodId])
  @@index([tenantId])
  @@index([periodId])
}

model FixedAssetDepreciationLine {
  id        String   @id @default(uuid())
  tenantId  String
  runId     String
  assetId   String
  amount    Decimal  @db.Decimal(18, 2)
  createdAt DateTime @default(now())

  tenant Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  run    FixedAssetDepreciationRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  asset  FixedAsset                @relation(fields: [assetId], references: [id], onDelete: Restrict)

  @@unique([tenantId, runId, assetId])
  @@index([tenantId])
  @@index([runId])
  @@index([assetId])
}

enum SupplierInvoiceStatus {
  DRAFT
  SUBMITTED
  APPROVED
  POSTED
}

enum CustomerInvoiceStatus {
  DRAFT
  POSTED
}

enum DocumentStatus {
  DRAFT
  SUBMITTED
  APPROVED
  POSTED
  VOID
}

enum InvoiceType {
  TRAINING
  CONSULTING
  SYSTEMS
  PUBLISHING
  DONATION
  OTHER
}

model InvoiceCategory {
  id                  String   @id @default(uuid())
  tenantId            String
  name                String
  code                String
  isActive            Boolean  @default(true)

  isSystemDefault     Boolean  @default(false)

  revenueAccountId    String
  revenueAccount      Account  @relation("InvoiceCategoryRevenueAccount", fields: [revenueAccountId], references: [id], onDelete: Restrict)

  requiresProject     Boolean  @default(false)
  requiresFund        Boolean  @default(false)
  requiresDepartment  Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  customerInvoices CustomerInvoice[]

  @@unique([tenantId, code])
  @@index([tenantId])
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
}

enum ReceiptStatus {
  DRAFT
  POSTED
  VOIDED
}

enum ReceiptPaymentMethod {
  CASH
  CARD
  EFT
  CHEQUE
  OTHER
}

enum RefundPaymentMethod {
  BANK
  CASH
}

enum PaymentType {
  SUPPLIER_PAYMENT
  CUSTOMER_RECEIPT
}

enum PaymentStatus {
  DRAFT
  APPROVED
  POSTED
}

enum PaymentAllocationSourceType {
  SUPPLIER_INVOICE
  CUSTOMER_INVOICE
}

enum TaxRateType {
  OUTPUT
  INPUT
}

enum InvoiceTaxSourceType {
  SUPPLIER_INVOICE
  CUSTOMER_INVOICE
}

model TenantTaxConfig {
  tenantId           String  @id
  outputVatAccountId String?
  inputVatAccountId  String?

  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  outputVatAccount Account? @relation("TenantTaxConfigOutputVatAccount", fields: [outputVatAccountId], references: [id], onDelete: Restrict)
  inputVatAccount  Account? @relation("TenantTaxConfigInputVatAccount", fields: [inputVatAccountId], references: [id], onDelete: Restrict)

  @@index([outputVatAccountId])
  @@index([inputVatAccountId])
}

model TaxRate {
  id          String      @id @default(uuid())
  tenantId    String
  code        String
  name        String
  rate        Decimal     @db.Decimal(5, 2)
  type        TaxRateType
  glAccountId String?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())

  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  glAccount Account?         @relation(fields: [glAccountId], references: [id], onDelete: Restrict)
  taxLines  InvoiceTaxLine[]
  customerInvoiceLines CustomerInvoiceLine[]

  @@unique([tenantId, name])
  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([glAccountId])
}

model BankStatement {
  id             String   @id @default(uuid())
  tenantId       String
  bankAccountId  String
  statementDate  DateTime
  openingBalance Decimal  @db.Decimal(18, 2)
  closingBalance Decimal  @db.Decimal(18, 2)
  createdAt      DateTime @default(now())

  tenant      Tenant              @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  bankAccount BankAccount         @relation(fields: [bankAccountId], references: [id], onDelete: Restrict)
  lines       BankStatementLine[]

  @@unique([tenantId, bankAccountId, statementDate])
  @@index([tenantId])
  @@index([bankAccountId])
}

model BankStatementLine {
  id              String    @id @default(uuid())
  bankStatementId String
  transactionDate DateTime
  description     String
  amount          Decimal   @db.Decimal(18, 2)
  reference       String?
  isReconciled    Boolean   @default(false)
  reconciledAt    DateTime?
  reconciledBy    String?

  bankStatement  BankStatement       @relation(fields: [bankStatementId], references: [id], onDelete: Cascade)
  reconciliation BankReconciliation?

  @@index([bankStatementId])
  @@index([transactionDate])
  @@index([isReconciled])
}

model BankReconciliation {
  id              String   @id @default(uuid())
  tenantId        String
  bankAccountId   String
  paymentId       String?
  statementLineId String
  reconciledAt    DateTime
  reconciledBy    String

  tenant        Tenant            @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  bankAccount   BankAccount       @relation(fields: [bankAccountId], references: [id], onDelete: Restrict)
  payment       Payment?          @relation(fields: [paymentId], references: [id], onDelete: Restrict)
  statementLine BankStatementLine @relation(fields: [statementLineId], references: [id], onDelete: Restrict)

  @@unique([statementLineId])
  @@unique([paymentId])
  @@index([tenantId])
  @@index([bankAccountId])
}

model InvoiceTaxLine {
  id            String               @id @default(uuid())
  tenantId      String
  sourceType    InvoiceTaxSourceType
  sourceId      String
  taxRateId     String
  taxableAmount Decimal              @db.Decimal(18, 2)
  taxAmount     Decimal              @db.Decimal(18, 2)
  createdAt     DateTime             @default(now())

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  taxRate TaxRate @relation(fields: [taxRateId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([sourceType, sourceId])
  @@index([taxRateId])
}

model BankAccount {
  id            String   @id @default(uuid())
  tenantId      String
  name          String
  bankName      String
  accountNumber String
  currency      String
  glAccountId   String
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  tenant          Tenant               @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  glAccount       Account              @relation(fields: [glAccountId], references: [id], onDelete: Restrict)
  payments        Payment[]
  customerRefunds CustomerRefund[]
  statements      BankStatement[]
  reconciliations BankReconciliation[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([glAccountId])
}

model Payment {
  id            String        @id @default(uuid())
  tenantId      String
  type          PaymentType
  bankAccountId String
  amount        Decimal       @db.Decimal(18, 2)
  paymentDate   DateTime
  reference     String?
  status        PaymentStatus @default(DRAFT)
  createdById   String
  approvedById  String?
  postedById    String?
  createdAt     DateTime      @default(now())
  approvedAt    DateTime?
  postedAt      DateTime?

  tenant          Tenant               @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  bankAccount     BankAccount          @relation(fields: [bankAccountId], references: [id], onDelete: Restrict)
  createdBy       User                 @relation("PaymentCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  approvedBy      User?                @relation("PaymentApprovedBy", fields: [approvedById], references: [id], onDelete: Restrict)
  postedBy        User?                @relation("PaymentPostedBy", fields: [postedById], references: [id], onDelete: Restrict)
  allocations     PaymentAllocation[]
  reconciliations BankReconciliation[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([bankAccountId])
}

model PaymentAllocation {
  id         String                      @id @default(uuid())
  paymentId  String
  sourceType PaymentAllocationSourceType
  sourceId   String
  amount     Decimal                     @db.Decimal(18, 2)

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([sourceType, sourceId])
}

model Customer {
  id             String         @id @default(uuid())
  tenantId       String
  customerCode   String?
  name           String
  contactPerson  String?
  email          String?
  phone          String?
  billingAddress String?
  taxNumber      String?
  status         CustomerStatus @default(ACTIVE)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @default(now()) @updatedAt

  tenant   Tenant            @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  invoices CustomerInvoice[]
  receipts CustomerReceipt[]
  creditNotes CustomerCreditNote[]
  refunds CustomerRefund[]

  @@unique([tenantId, customerCode])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, name])
}

model CustomerInvoice {
  id            String                @id @default(uuid())
  tenantId      String
  customerId    String
  invoiceNumber String
  invoiceDate   DateTime
  dueDate       DateTime
  currency      String
  exchangeRate  Decimal               @default(1.0) @db.Decimal(18, 6)
  invoiceType   InvoiceType?
  invoiceCategoryId String?
  projectId     String?
  fundId        String?
  departmentId  String?
  reference     String?
  invoiceNote   String?
  customerNameSnapshot String          @default("")
  customerEmailSnapshot String?
  customerBillingAddressSnapshot String?
  subtotal      Decimal               @db.Decimal(18, 2)
  taxAmount     Decimal               @db.Decimal(18, 2)
  isTaxable     Boolean               @default(false)
  totalAmount   Decimal               @db.Decimal(18, 2)
  status        CustomerInvoiceStatus @default(DRAFT)
  createdById   String
  postedById    String?
  createdAt     DateTime              @default(now())
  postedAt      DateTime?

  tenant     Tenant                @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  customer   Customer              @relation(fields: [customerId], references: [id], onDelete: Restrict)
  createdBy  User                  @relation("CustomerInvoiceCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  postedBy   User?                 @relation("CustomerInvoicePostedBy", fields: [postedById], references: [id], onDelete: Restrict)
  invoiceCategory InvoiceCategory?  @relation(fields: [invoiceCategoryId], references: [id], onDelete: Restrict)
  project    Project?              @relation("CustomerInvoiceProject", fields: [projectId], references: [id], onDelete: Restrict)
  fund       Fund?                 @relation(fields: [fundId], references: [id], onDelete: Restrict)
  department Department?           @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  lines      CustomerInvoiceLine[]
  receiptLines CustomerReceiptLine[]
  creditNotes CustomerCreditNote[] @relation("CustomerCreditNoteInvoice")

  @@unique([tenantId, customerId, invoiceNumber])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([invoiceCategoryId])
  @@index([projectId])
  @@index([fundId])
  @@index([departmentId])
}

model CustomerCreditNote {
  id              String         @id @default(uuid())
  tenantId         String
  creditNoteNumber String
  creditNoteDate   DateTime
  customerId       String
  invoiceId        String?
  memo             String?
  currency         String
  exchangeRate     Decimal        @default(1.0) @db.Decimal(18, 6)
  subtotal         Decimal        @db.Decimal(18, 2)
  totalAmount      Decimal        @db.Decimal(18, 2)
  status           DocumentStatus @default(DRAFT)
  createdById      String
  approvedById     String?
  postedById       String?
  voidedById       String?
  createdAt        DateTime       @default(now())
  approvedAt       DateTime?
  postedAt         DateTime?
  voidedAt         DateTime?
  voidReason       String?
  updatedAt        DateTime       @updatedAt

  postedJournalId String?

  tenant     Tenant          @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  customer   Customer        @relation(fields: [customerId], references: [id], onDelete: Restrict)
  invoice    CustomerInvoice? @relation("CustomerCreditNoteInvoice", fields: [invoiceId], references: [id], onDelete: Restrict)
  createdBy  User            @relation("CustomerCreditNoteCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  approvedBy User?           @relation("CustomerCreditNoteApprovedBy", fields: [approvedById], references: [id], onDelete: Restrict)
  postedBy   User?           @relation("CustomerCreditNotePostedBy", fields: [postedById], references: [id], onDelete: Restrict)
  voidedBy   User?           @relation("CustomerCreditNoteVoidedBy", fields: [voidedById], references: [id], onDelete: Restrict)
  postedJournal JournalEntry? @relation("CustomerCreditNotePostedJournal", fields: [postedJournalId], references: [id], onDelete: Restrict)
  lines      CustomerCreditNoteLine[]
  refunds    CustomerRefund[]

  @@unique([tenantId, creditNoteNumber])
  @@index([tenantId, creditNoteNumber])
  @@index([tenantId, customerId])
  @@index([tenantId, invoiceId])
  @@index([tenantId, status])
  @@unique([tenantId, postedJournalId])
}

model CustomerCreditNoteLine {
  id              String  @id @default(uuid())
  creditNoteId     String
  description      String
  quantity         Decimal @db.Decimal(18, 2)
  unitPrice        Decimal @db.Decimal(18, 2)
  lineAmount       Decimal @db.Decimal(18, 2)
  revenueAccountId String
  departmentId     String?
  projectId        String?
  fundId           String?

  creditNote      CustomerCreditNote @relation(fields: [creditNoteId], references: [id], onDelete: Cascade)
  revenueAccount  Account            @relation(fields: [revenueAccountId], references: [id], onDelete: Restrict)
  department      Department?        @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  project         Project?           @relation(fields: [projectId], references: [id], onDelete: Restrict)
  fund            Fund?              @relation(fields: [fundId], references: [id], onDelete: Restrict)

  @@index([creditNoteId])
}

model CustomerRefund {
  /// Rules:
  /// - At least one of receiptId or creditNoteId must be provided.
  /// - Refund cannot exceed available unapplied/credit balance (enforced later in Step 4.2).
  id           String         @id @default(uuid())
  tenantId      String
  refundNumber  String
  refundDate    DateTime
  customerId    String
  receiptId     String?
  creditNoteId  String?
  currency      String
  exchangeRate  Decimal        @default(1.0) @db.Decimal(18, 6)
  amount        Decimal        @db.Decimal(18, 2)
  paymentMethod RefundPaymentMethod
  bankAccountId String?
  status        DocumentStatus @default(DRAFT)
  createdById   String
  approvedById  String?
  postedById    String?
  voidedById    String?
  createdAt     DateTime       @default(now())
  approvedAt    DateTime?
  postedAt      DateTime?
  voidedAt      DateTime?
  voidReason    String?
  postedJournalId String?
  updatedAt     DateTime       @updatedAt

  tenant     Tenant             @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  customer   Customer           @relation(fields: [customerId], references: [id], onDelete: Restrict)
  receipt    CustomerReceipt?   @relation(fields: [receiptId], references: [id], onDelete: Restrict)
  creditNote CustomerCreditNote? @relation(fields: [creditNoteId], references: [id], onDelete: Restrict)
  bankAccount BankAccount?      @relation(fields: [bankAccountId], references: [id], onDelete: Restrict)
  createdBy  User               @relation("CustomerRefundCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  approvedBy User?              @relation("CustomerRefundApprovedBy", fields: [approvedById], references: [id], onDelete: Restrict)
  postedBy   User?              @relation("CustomerRefundPostedBy", fields: [postedById], references: [id], onDelete: Restrict)
  voidedBy   User?              @relation("CustomerRefundVoidedBy", fields: [voidedById], references: [id], onDelete: Restrict)

  postedJournal JournalEntry?   @relation("CustomerRefundPostedJournal", fields: [postedJournalId], references: [id], onDelete: Restrict)

  @@unique([tenantId, refundNumber])
  @@index([tenantId, refundNumber])
  @@index([tenantId, customerId])
  @@index([tenantId, creditNoteId])
  @@unique([tenantId, postedJournalId])
}

model AccountingPeriodChecklistItem {
  id            String   @id @default(uuid())
  tenantId      String
  periodId      String
  code          String
  label         String
  completed     Boolean  @default(false)
  completedById String?
  completedAt   DateTime?
  createdAt     DateTime @default(now())

  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  period      AccountingPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)
  completedBy User?            @relation("AccountingPeriodChecklistItemCompletedBy", fields: [completedById], references: [id], onDelete: Restrict)

  @@unique([tenantId, periodId, code])
  @@index([tenantId])
  @@index([periodId])
  @@index([completedById])
}

model AccountingPeriodChecklist {
  id            String   @id @default(uuid())
  tenantId      String
  periodId      String
  checklistCode String
  checklistName String
  required      Boolean  @default(true)
  completed     Boolean  @default(false)
  completedById String?
  completedAt   DateTime?
  createdAt     DateTime @default(now())

  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  period      AccountingPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)
  completedBy User?            @relation("AccountingPeriodChecklistCompletedBy", fields: [completedById], references: [id], onDelete: Restrict)

  @@unique([tenantId, periodId, checklistCode])
  @@index([tenantId])
  @@index([periodId])
  @@index([completedById])
}

model AccountingPeriodCloseLog {
  id        String   @id @default(uuid())
  tenantId  String
  periodId  String
  userId    String
  action    String
  outcome   String
  message   String?
  itemId    String?
  createdAt DateTime @default(now())

  tenant Tenant           @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  period AccountingPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)
  user   User             @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([periodId])
  @@index([userId])
}

model AuditEvent {
  id             String        @id @default(uuid())
  tenantId       String
  eventType      AuditEventType
  entityType     AuditEntityType
  entityId       String
  action         String
  outcome        AuditOutcome
  reason         String?
  userId         String
  permissionUsed String?
  forecastId      String?
  forecastVersionId String?
  createdAt      DateTime      @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([tenantId, createdAt])
  @@index([tenantId, entityType, entityId])
  @@index([tenantId, userId])
  @@index([tenantId, forecastId])
  @@index([tenantId, forecastVersionId])
  @@index([tenantId, eventType, createdAt])
  @@index([entityType, entityId])
}

enum ForecastStatus {
  DRAFT
  SUBMITTED
  APPROVED
  SUPERSEDED
}

model Forecast {
  id        String         @id @default(uuid())
  tenantId  String
  fiscalYear Int
  name      String
  status    ForecastStatus @default(DRAFT)
  createdById String
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  createdBy User   @relation("ForecastCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)

  versions ForecastVersion[]

  @@unique([tenantId, fiscalYear])
  @@index([tenantId])
  @@index([tenantId, fiscalYear])
  @@index([createdById])
}

model ForecastVersion {
  id            String         @id @default(uuid())
  forecastId    String
  versionNumber Int
  status        ForecastStatus @default(DRAFT)
  createdById   String
  createdAt     DateTime       @default(now())

  forecast  Forecast @relation(fields: [forecastId], references: [id], onDelete: Cascade)
  createdBy User     @relation("ForecastVersionCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)

  lines ForecastLine[]

  @@unique([forecastId, versionNumber])
  @@index([forecastId])
  @@index([createdById])
  @@index([forecastId, status])
}

model ForecastLine {
  id                String  @id @default(uuid())
  forecastVersionId String
  accountId         String
  month             Int
  amount            Decimal @db.Decimal(18, 2)

  version ForecastVersion @relation(fields: [forecastVersionId], references: [id], onDelete: Cascade)
  account Account         @relation(fields: [accountId], references: [id], onDelete: Restrict)

  @@index([forecastVersionId])
  @@index([accountId])
  @@index([forecastVersionId, month])
  @@index([forecastVersionId, accountId, month])
  @@unique([forecastVersionId, accountId, month])
}

model AuditEvidence {
  id           String        @id @default(uuid())
  tenantId     String
  entityType   AuditEntityType
  entityId     String
  fileName     String
  mimeType     String
  size         Int
  storageKey   String
  sha256Hash   String
  uploadedById String
  createdAt    DateTime      @default(now())

  tenant     Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  uploadedBy User   @relation("AuditEvidenceUploadedBy", fields: [uploadedById], references: [id], onDelete: Restrict)

  @@unique([tenantId, storageKey])
  @@index([tenantId])
  @@index([tenantId, entityType, entityId])
  @@index([uploadedById])
  @@index([tenantId, createdAt])
}

model ReviewPack {
  id              String   @id @default(uuid())
  tenantId        String
  periodId        String
  generatedById   String
  storageKey      String
  zipSize         Int
  zipSha256Hash   String
  manifest        Json
  manifestSha256  String
  createdAt       DateTime @default(now())

  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  period      AccountingPeriod @relation(fields: [periodId], references: [id], onDelete: Restrict)
  generatedBy User             @relation("ReviewPackGeneratedBy", fields: [generatedById], references: [id], onDelete: Restrict)

  @@unique([tenantId, storageKey])
  @@index([tenantId])
  @@index([tenantId, periodId])
  @@index([tenantId, createdAt])
}

model CustomerInvoiceLine {
  id                String  @id @default(uuid())
  customerInvoiceId String
  accountId         String
  taxRateId         String?
  departmentId      String?
  projectId         String?
  fundId            String?
  description       String
  quantity          Decimal @db.Decimal(18, 6)
  unitPrice         Decimal @db.Decimal(18, 6)
  discountPercent   Decimal? @db.Decimal(18, 6)
  discountAmount    Decimal? @db.Decimal(18, 2)
  discountTotal     Decimal  @default(0) @db.Decimal(18, 2)
  lineTotal         Decimal @db.Decimal(18, 2)

  customerInvoice CustomerInvoice @relation(fields: [customerInvoiceId], references: [id], onDelete: Cascade)
  account         Account         @relation(fields: [accountId], references: [id], onDelete: Restrict)
  taxRate         TaxRate?        @relation(fields: [taxRateId], references: [id], onDelete: Restrict)
  department      Department?    @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  project         Project?       @relation(fields: [projectId], references: [id], onDelete: Restrict)
  fund            Fund?          @relation(fields: [fundId], references: [id], onDelete: Restrict)

  @@index([customerInvoiceId])
  @@index([accountId])
  @@index([taxRateId])
  @@index([departmentId])
  @@index([projectId])
  @@index([fundId])
}

model CustomerInvoiceImportLog {
  id          String   @id @default(uuid())
  tenantId    String
  importId    String
  processedAt DateTime @default(now())
  processedById String?

  tenant      Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  processedBy User?  @relation("CustomerInvoiceImportProcessedBy", fields: [processedById], references: [id], onDelete: Restrict)

  @@unique([tenantId, importId])
  @@index([tenantId])
  @@index([tenantId, processedAt])
  @@index([processedById])
}

model CustomerReceipt {
  id              String               @id @default(uuid())
  tenantId         String
  receiptNumber    String
  receiptDate      DateTime
  customerId       String
  currency         String
  exchangeRate     Decimal              @default(1.0) @db.Decimal(18, 6)
  totalAmount      Decimal              @db.Decimal(18, 2)
  paymentMethod    ReceiptPaymentMethod
  paymentReference String?
  status           ReceiptStatus        @default(DRAFT)
  createdById      String
  createdAt        DateTime             @default(now())
  postedByUserId   String?
  postedById       String?
  postedAt         DateTime?
  voidedById       String?
  voidedAt         DateTime?
  voidReason       String?

  glJournalId String?

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  customer    Customer     @relation(fields: [customerId], references: [id], onDelete: Restrict)
  createdBy   User         @relation("CustomerReceiptCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  postedBy    User?        @relation("CustomerReceiptPostedBy", fields: [postedById], references: [id], onDelete: Restrict)
  voidedBy    User?        @relation("CustomerReceiptVoidedBy", fields: [voidedById], references: [id], onDelete: Restrict)
  glJournal   JournalEntry? @relation("CustomerReceiptGlJournal", fields: [glJournalId], references: [id], onDelete: Restrict)
  lines       CustomerReceiptLine[]
  refunds     CustomerRefund[]

  @@unique([tenantId, receiptNumber])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([customerId])
}

model CustomerReceiptLine {
  id            String  @id @default(uuid())
  tenantId      String
  receiptId     String
  invoiceId     String
  appliedAmount Decimal @db.Decimal(18, 2)
  createdAt     DateTime @default(now())

  tenant  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  receipt CustomerReceipt @relation(fields: [receiptId], references: [id], onDelete: Restrict)
  invoice CustomerInvoice @relation(fields: [invoiceId], references: [id], onDelete: Restrict)

  @@index([receiptId])
  @@index([invoiceId])
  @@index([tenantId])
  @@unique([receiptId, invoiceId])
}

model Supplier {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  taxNumber String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  tenant      Tenant            @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  invoices    SupplierInvoice[]
  fixedAssets FixedAsset[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model SupplierInvoice {
  id            String                @id @default(uuid())
  tenantId      String
  supplierId    String
  invoiceNumber String
  invoiceDate   DateTime
  dueDate       DateTime
  totalAmount   Decimal               @db.Decimal(18, 2)
  status        SupplierInvoiceStatus @default(DRAFT)
  createdById   String
  approvedById  String?
  postedById    String?
  createdAt     DateTime              @default(now())
  approvedAt    DateTime?
  postedAt      DateTime?

  tenant      Tenant                @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  supplier    Supplier              @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  createdBy   User                  @relation("SupplierInvoiceCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  approvedBy  User?                 @relation("SupplierInvoiceApprovedBy", fields: [approvedById], references: [id], onDelete: Restrict)
  postedBy    User?                 @relation("SupplierInvoicePostedBy", fields: [postedById], references: [id], onDelete: Restrict)
  lines       SupplierInvoiceLine[]
  fixedAssets FixedAsset[]

  @@unique([tenantId, supplierId, invoiceNumber])
  @@index([tenantId])
  @@index([tenantId, status])
}

model SupplierInvoiceLine {
  id                String  @id @default(uuid())
  supplierInvoiceId String
  accountId         String
  description       String
  amount            Decimal @db.Decimal(18, 2)

  supplierInvoice SupplierInvoice @relation(fields: [supplierInvoiceId], references: [id], onDelete: Cascade)
  account         Account         @relation(fields: [accountId], references: [id], onDelete: Restrict)

  @@index([supplierInvoiceId])
  @@index([accountId])
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TenantStatus {
  ACTIVE
  INACTIVE
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  INCOME
  EXPENSE
}

enum DepreciationMethod {
  STRAIGHT_LINE
}

enum FixedAssetStatus {
  DRAFT
  CAPITALIZED
  DISPOSED
}

enum FixedAssetDepreciationRunStatus {
  POSTED
}

enum JournalStatus {
  DRAFT
  SUBMITTED
  REVIEWED
  REJECTED
  PARKED
  POSTED
}

enum JournalType {
  STANDARD
  ADJUSTING
  ACCRUAL
  REVERSING
}

enum RecurringJournalFrequency {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum NormalBalance {
  DEBIT
  CREDIT
}

enum AccountingPeriodStatus {
  OPEN
  SOFT_CLOSED
  CLOSED
}

enum AccountingPeriodType {
  OPENING
  NORMAL
}

enum PeriodCloseChecklistItemStatus {
  PENDING
  COMPLETED
}

enum AuditOutcome {
  SUCCESS
  BLOCKED
  FAILED
}

enum MasterStatus {
  ACTIVE
  INACTIVE
}

enum ProjectStatus {
  ACTIVE
  CLOSED
}

enum AuditEventType {
  JOURNAL_CREATE
  JOURNAL_UPDATE
  JOURNAL_PARK
  JOURNAL_POST
  JOURNAL_REVERSE
  JOURNAL_UPLOAD
  JOURNAL_UPLOAD_FAILED
  GL_JOURNAL_SUBMITTED
  GL_JOURNAL_REVIEWED
  GL_JOURNAL_REJECTED
  GL_JOURNAL_POSTED
  GL_JOURNAL_REVERSED
  GL_JOURNAL_BUDGET_EVALUATED
  GL_JOURNAL_RISK_COMPUTED
  GL_JOURNAL_REVERSAL_INITIATED
  GL_JOURNAL_REVERSAL_ASSIGNED
  GL_JOURNAL_REVERSAL_APPROVED
  GL_JOURNAL_REVERSAL_POSTED
  GL_JOURNAL_POST_BLOCKED
  GL_JOURNAL_RETURNED_BY_POSTER
  RECURRING_TEMPLATE_CREATE
  RECURRING_TEMPLATE_UPDATE
  RECURRING_JOURNAL_GENERATED
  PERIOD_CHECKLIST_COMPLETE
  PERIOD_CREATED
  PERIOD_CLOSED
  PERIOD_CLOSE
  PERIOD_REOPEN
  PERIOD_REOPENED
  SOD_VIOLATION
  USER_CREATE
  USER_STATUS_CHANGE
  USER_ROLE_ASSIGN
  AP_POST
  AR_POST
  FA_POST
  FA_CAPITALIZE
  FA_DEPRECIATION_RUN
  FA_DISPOSE
  BANK_RECONCILIATION_MATCH
  EVIDENCE_UPLOAD
  BUDGET_CREATE
  BUDGET_APPROVE
  REPORT_VIEW
  REPORT_EXPORT
  DISCLOSURE_NOTE_GENERATE
  DISCLOSURE_NOTE_VIEW
  DASHBOARD_VIEW
  FORECAST_CREATE
  FORECAST_UPDATE
  FORECAST_SUBMIT
  FORECAST_APPROVE
  FORECAST_SUPERSEDE
  FORECAST_VIEW
  COA_CREATE
  COA_UPDATE
  COA_HIERARCHY_CHANGE
  COA_DEACTIVATE
  COA_FREEZE
  COA_UNFREEZE
  COA_LOCKED
  COA_UNLOCKED
  COA_IMPORTED
  COA_CLEANUP_EXECUTED
  ORGANISATION_UPDATE
  ORGANISATION_LOGO_UPLOAD

  DEPARTMENT_CREATED
  DEPARTMENT_UPDATED
  PROJECT_CREATED
  PROJECT_UPDATED
  PROJECT_CLOSED
  FUND_CREATED
  FUND_UPDATED

  INVOICE_CATEGORY_CREATED
  INVOICE_CATEGORY_UPDATED
  INVOICE_CATEGORY_STATUS_CHANGE

  TAX_RATE_CREATED
  TAX_RATE_UPDATED
  TAX_RATE_STATUS_CHANGE
  TAX_CONFIG_UPDATED
}

enum BudgetStatus {
  DRAFT
  ACTIVE
}

enum BudgetControlMode {
  WARN
  BLOCK
}

enum JournalBudgetStatus {
  OK
  WARN
  BLOCK
}

enum AuditEntityType {
  JOURNAL_ENTRY
  ACCOUNTING_PERIOD
  ACCOUNTING_PERIOD_CHECKLIST_ITEM
  SUPPLIER_INVOICE
  CUSTOMER_INVOICE
  CUSTOMER_RECEIPT
  FIXED_ASSET
  FIXED_ASSET_DEPRECIATION_RUN
  BANK_RECONCILIATION_MATCH
  USER
  BUDGET
  REPORT
  DISCLOSURE_NOTE
  FORECAST
  TENANT
  ACCOUNT
  CHART_OF_ACCOUNTS
  RECURRING_JOURNAL_TEMPLATE
  INVOICE_CATEGORY
  TAX_RATE
  TENANT_TAX_CONFIG
  DEPARTMENT
  PROJECT
  FUND
}

enum DisclosureNoteType {
  PPE_MOVEMENT
  DEPRECIATION
  TAX_RECONCILIATION
  PROVISIONS
  CONTINGENCIES
}

model Tenant {
  id                    String       @id @default(uuid())
  name                  String
  organisationName      String   @default("USPIRE ERP")
  organisationShortName String?
  logoUrl               String?
  primaryColor          String   @default("#020445")
  secondaryColor        String?
  legalName               String?
  defaultCurrency         String?
  country                 String?
  timezone                String?
  financialYearStartMonth Int?
  dateFormat              String?
  numberFormat            String?
  defaultLandingPage      String?
  defaultDashboard        String?
  defaultLanguage         String?
  demoModeEnabled         Boolean? @default(false)
  defaultUserRoleCode     String?
  faviconUrl              String?
  accentColor             String?
  secondaryAccentColor    String?

  allowSelfPosting Boolean @default(false)

  receiptBankName          String?
  receiptBankAccountName   String?
  receiptBankAccountNumber String?
  receiptBankBranch        String?
  receiptBankSwiftCode     String?

  requiresDepartmentOnInvoices Boolean @default(false)
  requiresProjectOnInvoices    Boolean @default(false)
  requiresFundOnInvoices       Boolean @default(false)

  arControlAccountId          String?
  defaultBankClearingAccountId String?
  unappliedReceiptsAccountId   String?
  cashClearingAccountId        String?
  coaFrozen               Boolean  @default(false)
  coaLockedAt             DateTime?
  status    TenantStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @default(now()) @updatedAt

  entities            Entity[]
  users               User[]
  roles               Role[]
  sodRules            SoDRule[]
  sodLogs             SoDViolationLog[]
  accounts            Account[]
  journals            JournalEntry[]
  periods             AccountingPeriod[]
  suppliers           Supplier[]
  supplierInvoices    SupplierInvoice[]
  customers           Customer[]
  customerInvoices    CustomerInvoice[]
  customerReceipts    CustomerReceipt[]
  customerCreditNotes CustomerCreditNote[]
  refunds             CustomerRefund[]
  customerReceiptLines CustomerReceiptLine[]
  customerInvoiceImportLogs CustomerInvoiceImportLog[]
  invoiceCategories   InvoiceCategory[]
  bankAccounts        BankAccount[]
  payments            Payment[]
  bankStatements      BankStatement[]
  bankReconciliations BankReconciliation[]
  taxRates            TaxRate[]
  invoiceTaxLines     InvoiceTaxLine[]

  taxConfig TenantTaxConfig?

  fixedAssetCategories        FixedAssetCategory[]
  fixedAssets                 FixedAsset[]
  fixedAssetDepreciationRuns  FixedAssetDepreciationRun[]
  fixedAssetDepreciationLines FixedAssetDepreciationLine[]

  periodCloseChecklists PeriodCloseChecklist[]
  periodCloseChecklistItems PeriodCloseChecklistItem[]

  accountingPeriodChecklistItems AccountingPeriodChecklistItem[]

  accountingPeriodChecklists AccountingPeriodChecklist[]

  accountingPeriodCloseLogs AccountingPeriodCloseLog[]

  auditEvents AuditEvent[]

  sequenceCounters TenantSequenceCounter[]

  auditEvidence AuditEvidence[]

  reviewPacks ReviewPack[]

  disclosureNotes DisclosureNote[]

  budgets Budget[]

  budgetRevisions BudgetRevision[]
  budgetLines     BudgetLine[]

  forecasts Forecast[]

  recurringJournalTemplates   RecurringJournalTemplate[]
  recurringJournalGenerations RecurringJournalGeneration[]

  coaCanonicalSnapshots CoaCanonicalSnapshot[]

  legalEntities LegalEntity[]
  departments   Department[]
  projects      Project[]
  funds         Fund[]

  arControlAccount           Account? @relation("TenantArControlAccount", fields: [arControlAccountId], references: [id], onDelete: Restrict)
  defaultBankClearingAccount Account? @relation("TenantDefaultBankClearingAccount", fields: [defaultBankClearingAccountId], references: [id], onDelete: Restrict)
  unappliedReceiptsAccount   Account? @relation("TenantUnappliedReceiptsAccount", fields: [unappliedReceiptsAccountId], references: [id], onDelete: Restrict)
  cashClearingAccount        Account? @relation("TenantCashClearingAccount", fields: [cashClearingAccountId], references: [id], onDelete: Restrict)

  @@unique([name])
  @@index([status])
}

model Entity {
  id              String   @id @default(uuid())
  tenantId        String
  name            String
  jurisdiction    String
  baseCurrency    String
  fiscalYearStart Int
  createdAt       DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  @@unique([tenantId, name])
  @@index([tenantId])
}

model LegalEntity {
  id            String   @id @default(uuid())
  tenantId      String
  code          String
  name          String
  isActive      Boolean  @default(true)
  effectiveFrom DateTime
  effectiveTo   DateTime?
  createdById   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  createdBy User?  @relation("LegalEntityCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)

  journalLines JournalLine[]
  budgetLines  BudgetLine[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([tenantId, effectiveFrom])
  @@index([tenantId, effectiveTo])
  @@index([createdById])
}

model Project {
  id            String   @id @default(uuid())
  tenantId      String
  code          String
  name          String
  status        ProjectStatus @default(ACTIVE)
  isRestricted  Boolean  @default(false)
  isActive      Boolean  @default(true)
  effectiveFrom DateTime
  effectiveTo   DateTime?
  createdById   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  createdBy User?  @relation("ProjectCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)

  funds        Fund[]
  invoiceLines CustomerInvoiceLine[]
  customerInvoices CustomerInvoice[] @relation("CustomerInvoiceProject")
  customerCreditNoteLines CustomerCreditNoteLine[]
  journalLines JournalLine[]
  budgetLines  BudgetLine[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, isActive])
  @@index([tenantId, isRestricted])
  @@index([tenantId, effectiveFrom])
  @@index([tenantId, effectiveTo])
  @@index([createdById])
}

model Fund {
  id            String   @id @default(uuid())
  tenantId      String
  projectId     String
  code          String
  name          String
  status        MasterStatus @default(ACTIVE)
  isActive      Boolean  @default(true)
  effectiveFrom DateTime
  effectiveTo   DateTime?
  createdById   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Restrict)
  createdBy User?    @relation("FundCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)

  journalLines JournalLine[]
  invoiceLines CustomerInvoiceLine[]
  customerInvoices CustomerInvoice[]
  customerCreditNoteLines CustomerCreditNoteLine[]
  budgetLines  BudgetLine[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, projectId])
  @@index([tenantId, isActive])
  @@index([tenantId, effectiveFrom])
  @@index([tenantId, effectiveTo])
  @@index([createdById])
}

model Department {
  id            String   @id @default(uuid())
  tenantId      String
  code          String
  name          String
  status        MasterStatus @default(ACTIVE)
  isActive      Boolean  @default(true)
  effectiveFrom DateTime
  effectiveTo   DateTime?
  createdById   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  createdBy User?  @relation("DepartmentCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)

  journalLines JournalLine[]
  invoiceLines CustomerInvoiceLine[]
  customerInvoices CustomerInvoice[]
  customerCreditNoteLines CustomerCreditNoteLine[]
  budgetLines  BudgetLine[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([tenantId, effectiveFrom])
  @@index([tenantId, effectiveTo])
  @@index([createdById])
}

model User {
  id           String   @id @default(uuid())
  tenantId     String
  name         String
  email        String
  passwordHash String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  tenant                           Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  userRoles                        UserRole[]
  sodLogs                          SoDViolationLog[]
  journalsCreated                  JournalEntry[]              @relation("JournalCreatedBy")
  journalsReversalInitiated        JournalEntry[]              @relation("JournalReversalInitiatedBy")
  journalsReversalPrepared         JournalEntry[]              @relation("JournalReversalPreparedBy")
  journalsSubmitted                JournalEntry[]              @relation("JournalSubmittedBy")
  journalsReviewed                 JournalEntry[]              @relation("JournalReviewedBy")
  journalsRejected                 JournalEntry[]              @relation("JournalRejectedBy")
  journalsApproved                 JournalEntry[]              @relation("JournalApprovedBy")
  journalsPosted                   JournalEntry[]              @relation("JournalPostedBy")
  journalsReturnedByPoster         JournalEntry[]              @relation("JournalReturnedByPoster")
  periodsClosed                    AccountingPeriod[]          @relation("PeriodClosedBy")
  accountingPeriodsCreated         AccountingPeriod[]          @relation("AccountingPeriodCreatedBy")
  supplierInvoicesCreated          SupplierInvoice[]           @relation("SupplierInvoiceCreatedBy")
  supplierInvoicesApproved         SupplierInvoice[]           @relation("SupplierInvoiceApprovedBy")
  supplierInvoicesPosted           SupplierInvoice[]           @relation("SupplierInvoicePostedBy")
  customerInvoicesCreated          CustomerInvoice[]           @relation("CustomerInvoiceCreatedBy")
  customerInvoicesPosted           CustomerInvoice[]           @relation("CustomerInvoicePostedBy")
  customerCreditNotesCreated       CustomerCreditNote[]        @relation("CustomerCreditNoteCreatedBy")
  customerCreditNotesPosted        CustomerCreditNote[]        @relation("CustomerCreditNotePostedBy")
  customerCreditNotesApproved      CustomerCreditNote[]        @relation("CustomerCreditNoteApprovedBy")
  customerCreditNotesVoided        CustomerCreditNote[]        @relation("CustomerCreditNoteVoidedBy")
  customerInvoiceImportsProcessed  CustomerInvoiceImportLog[]  @relation("CustomerInvoiceImportProcessedBy")
  customerReceiptsCreated          CustomerReceipt[]           @relation("CustomerReceiptCreatedBy")
  customerReceiptsPosted           CustomerReceipt[]           @relation("CustomerReceiptPostedBy")
  customerReceiptsVoided           CustomerReceipt[]           @relation("CustomerReceiptVoidedBy")
  customerRefundsCreated           CustomerRefund[]            @relation("CustomerRefundCreatedBy")
  customerRefundsApproved          CustomerRefund[]            @relation("CustomerRefundApprovedBy")
  customerRefundsPosted            CustomerRefund[]            @relation("CustomerRefundPostedBy")
  customerRefundsVoided            CustomerRefund[]            @relation("CustomerRefundVoidedBy")
  paymentsCreated                  Payment[]                   @relation("PaymentCreatedBy")
  paymentsApproved                 Payment[]                   @relation("PaymentApprovedBy")
  paymentsPosted                   Payment[]                   @relation("PaymentPostedBy")
  fixedAssetDepreciationRunsPosted FixedAssetDepreciationRun[] @relation("FixedAssetDepreciationRunPostedBy")
  fixedAssetsCreated               FixedAsset[]                @relation("FixedAssetCreatedBy")

  projectsCreated Project[] @relation("ProjectCreatedBy")
  fundsCreated    Fund[]    @relation("FundCreatedBy")

  periodCloseChecklistItemsCompleted PeriodCloseChecklistItem[] @relation("PeriodCloseChecklistItemCompletedBy")

  accountingPeriodChecklistItemsCompleted AccountingPeriodChecklistItem[] @relation("AccountingPeriodChecklistItemCompletedBy")

  accountingPeriodChecklistsCompleted AccountingPeriodChecklist[] @relation("AccountingPeriodChecklistCompletedBy")

  accountingPeriodCloseLogs AccountingPeriodCloseLog[]

  auditEvents AuditEvent[]

  accountsCreated Account[] @relation("AccountCreatedBy")

  auditEvidenceUploaded AuditEvidence[] @relation("AuditEvidenceUploadedBy")

  reviewPacksGenerated ReviewPack[] @relation("ReviewPackGeneratedBy")

  disclosureNotesGenerated DisclosureNote[] @relation("DisclosureNoteGeneratedBy")

  budgetsCreated  Budget[]          @relation("BudgetCreatedBy")
  budgetsApproved Budget[]          @relation("BudgetApprovedBy")
  budgetRevisions BudgetRevision[]  @relation("BudgetRevisionCreatedBy")

  forecastsCreated        Forecast[]        @relation("ForecastCreatedBy")
  forecastVersionsCreated ForecastVersion[] @relation("ForecastVersionCreatedBy")

  recurringJournalTemplatesCreated RecurringJournalTemplate[]   @relation("RecurringTemplateCreatedBy")
  recurringJournalGenerations      RecurringJournalGeneration[] @relation("RecurringJournalGeneratedBy")

  coaCanonicalSnapshotsUploaded CoaCanonicalSnapshot[] @relation("CoaCanonicalSnapshotUploadedBy")

  legalEntitiesCreated LegalEntity[] @relation("LegalEntityCreatedBy")
  departmentsCreated   Department[]  @relation("DepartmentCreatedBy")

  @@unique([tenantId, email])
  @@index([tenantId])
}

model Role {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  createdAt   DateTime @default(now())

  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  rolePermissions RolePermission[]
  userRoles       UserRole[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Permission {
  id          String  @id @default(uuid())
  code        String  @unique
  description String?

  rolePermissions RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([permissionId])
}

model UserRole {
  userId String
  roleId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@index([roleId])
}

model SoDRule {
  id                   String   @id @default(uuid())
  tenantId             String
  forbiddenPermissionA String
  forbiddenPermissionB String
  description          String?
  createdAt            DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)

  @@unique([tenantId, forbiddenPermissionA, forbiddenPermissionB])
  @@index([tenantId])
}

model SoDViolationLog {
  id                    String   @id @default(uuid())
  tenantId              String
  userId                String
  permissionAttempted   String
  conflictingPermission String
  timestamp             DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([userId])
}

model Account {
  id            String      @id @default(uuid())
  tenantId      String
  code          String
  name          String
  type          AccountType
  subCategory String?
  fsMappingLevel1 String?
  fsMappingLevel2 String?
  isCashEquivalent Boolean @default(false)
  requiresDepartment Boolean @default(false)
  requiresProject Boolean @default(false)
  requiresFund Boolean @default(false)
  isBudgetRelevant Boolean @default(false)
  budgetControlMode BudgetControlMode @default(WARN)
  isActive  Boolean     @default(true)
  parentAccountId String?
  isPosting Boolean @default(true)
  isPostingAllowed Boolean @default(true)
  isControlAccount Boolean @default(false)
  normalBalance NormalBalance @default(DEBIT)
  hierarchyPath String?
  isFrozen  Boolean @default(false)
  ifrsMappingCode String?
  createdById String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @default(now()) @updatedAt

  tenant                                  Tenant                @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  parentAccount Account? @relation("AccountHierarchy", fields: [parentAccountId], references: [id], onDelete: Restrict)
  childAccounts Account[] @relation("AccountHierarchy")
  createdBy User? @relation("AccountCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  lines                                   JournalLine[]
  supplierInvoiceLines                    SupplierInvoiceLine[]
  customerInvoiceLines                    CustomerInvoiceLine[]
  bankAccounts                            BankAccount[]
  taxRates                                TaxRate[]
  fixedAssetCategoriesAsAssetAccount      FixedAssetCategory[]  @relation("FixedAssetCategoryAssetAccount")
  fixedAssetCategoriesAsAccumDepAccount   FixedAssetCategory[]  @relation("FixedAssetCategoryAccumDepAccount")
  fixedAssetCategoriesAsDepExpenseAccount FixedAssetCategory[]  @relation("FixedAssetCategoryDepExpenseAccount")
  fixedAssetsAsAssetAccount               FixedAsset[]          @relation("FixedAssetAssetAccount")
  fixedAssetsAsAccumDepAccount            FixedAsset[]          @relation("FixedAssetAccumDepAccount")
  fixedAssetsAsDepExpenseAccount          FixedAsset[]          @relation("FixedAssetDepExpenseAccount")

  invoiceCategoriesAsRevenueAccount InvoiceCategory[] @relation("InvoiceCategoryRevenueAccount")

  tenantTaxConfigsAsOutputVatAccount TenantTaxConfig[] @relation("TenantTaxConfigOutputVatAccount")
  tenantTaxConfigsAsInputVatAccount  TenantTaxConfig[] @relation("TenantTaxConfigInputVatAccount")

  customerCreditNoteLinesAsRevenueAccount CustomerCreditNoteLine[]

  budgetLines BudgetLine[]

  forecastLines ForecastLine[]

  recurringTemplateLines RecurringJournalTemplateLine[]

  tenantsAsArControlAccount            Tenant[] @relation("TenantArControlAccount")
  tenantsAsDefaultBankClearingAccount  Tenant[] @relation("TenantDefaultBankClearingAccount")
  tenantsAsUnappliedReceiptsAccount    Tenant[] @relation("TenantUnappliedReceiptsAccount")
  tenantsAsCashClearingAccount         Tenant[] @relation("TenantCashClearingAccount")

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, parentAccountId])
  @@index([createdById])
}

model CoaCanonicalSnapshot {
  id           String   @id @default(uuid())
  tenantId     String
  uploadedAt   DateTime @default(now())
  uploadedById String?
  fileName     String?
  format       String?
  rowCount     Int      @default(0)
  hash         String?
  data         Json

  tenant     Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  uploadedBy User?  @relation("CoaCanonicalSnapshotUploadedBy", fields: [uploadedById], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([uploadedAt])
}

model JournalEntry {
  id          String        @id @default(uuid())
  tenantId    String
  journalNumber Int?
  journalType  JournalType  @default(STANDARD)
  periodId     String?
  sourceType  String?
  sourceId    String?
  reference   String?
  description String?
  journalDate DateTime      @default(now())
  status      JournalStatus @default(DRAFT)
  createdById String
  correctsJournalId String?
  riskScore Int @default(0)
  riskFlags Json @default(dbgenerated("'[]'::jsonb"))
  riskComputedAt DateTime?
  budgetStatus JournalBudgetStatus @default(OK)
  budgetFlags Json?
  budgetCheckedAt DateTime?
  budgetOverrideJustification String?
  reversalInitiatedById String?
  reversalInitiatedAt DateTime?
  reversalPreparedById String?
  submittedById String?
  submittedAt DateTime?
  reviewedById String?
  reviewedAt DateTime?
  rejectedById String?
  rejectedAt DateTime?
  rejectionReason String?
  approvedById String?
  approvedAt DateTime?
  postedById  String?
  returnedByPosterId String?
  returnedByPosterAt DateTime?
  returnReason String?
  reversalOfId String?
  reversalReason String?
  createdAt   DateTime      @default(now())
  postedAt    DateTime?

  tenant                     Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  period                     AccountingPeriod?           @relation(fields: [periodId], references: [id], onDelete: Restrict)
  createdBy                  User                        @relation("JournalCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  reversalInitiatedBy         User?                       @relation("JournalReversalInitiatedBy", fields: [reversalInitiatedById], references: [id], onDelete: Restrict)
  reversalPreparedBy          User?                       @relation("JournalReversalPreparedBy", fields: [reversalPreparedById], references: [id], onDelete: Restrict)
  submittedBy                User?                       @relation("JournalSubmittedBy", fields: [submittedById], references: [id], onDelete: Restrict)
  reviewedBy                 User?                       @relation("JournalReviewedBy", fields: [reviewedById], references: [id], onDelete: Restrict)
  rejectedBy                 User?                       @relation("JournalRejectedBy", fields: [rejectedById], references: [id], onDelete: Restrict)
  approvedBy                 User?                       @relation("JournalApprovedBy", fields: [approvedById], references: [id], onDelete: Restrict)
  postedBy                   User?                       @relation("JournalPostedBy", fields: [postedById], references: [id], onDelete: Restrict)
  returnedByPoster           User?                       @relation("JournalReturnedByPoster", fields: [returnedByPosterId], references: [id], onDelete: Restrict)
  lines                      JournalLine[]
  correctsJournal            JournalEntry?               @relation("JournalCorrection", fields: [correctsJournalId], references: [id], onDelete: Restrict)
  correctedBy                JournalEntry[]              @relation("JournalCorrection")
  reversalOf                 JournalEntry?               @relation("JournalReversal", fields: [reversalOfId], references: [id], onDelete: Restrict)
  reversedBy                 JournalEntry[]              @relation("JournalReversal")
  fixedAssetCapitalizations  FixedAsset[]                @relation("FixedAssetCapitalizationJournal")
  fixedAssetDisposals        FixedAsset[]                @relation("FixedAssetDisposalJournal")
  fixedAssetDepreciationRuns FixedAssetDepreciationRun[] @relation("FixedAssetDepreciationRunJournal")

  customerReceiptsGl CustomerReceipt[] @relation("CustomerReceiptGlJournal")

  customerCreditNotesPosted CustomerCreditNote[] @relation("CustomerCreditNotePostedJournal")

  customerRefundsPosted CustomerRefund[] @relation("CustomerRefundPostedJournal")

  recurringGenerations RecurringJournalGeneration[] @relation("RecurringGeneratedJournal")

  @@index([tenantId])
  @@unique([tenantId, journalNumber])
  @@index([tenantId, journalType])
  @@index([tenantId, periodId])
  @@index([tenantId, status])
  @@index([tenantId, status, journalDate])
  @@index([tenantId, sourceType, sourceId])
}

model RecurringJournalTemplate {
  id                  String                   @id @default(uuid())
  tenantId             String
  name                String
  journalType          JournalType              @default(STANDARD)
  referenceTemplate    String
  descriptionTemplate  String?
  frequency            RecurringJournalFrequency
  startDate            DateTime
  endDate              DateTime?
  nextRunDate          DateTime
  isActive             Boolean                  @default(true)
  createdById          String
  createdAt            DateTime                 @default(now())

  tenant     Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  createdBy  User   @relation("RecurringTemplateCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)

  lines    RecurringJournalTemplateLine[]
  history  RecurringJournalGeneration[]

  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([tenantId, nextRunDate])
  @@index([createdById])
  @@unique([tenantId, name])
}

model RecurringJournalTemplateLine {
  id                  String                  @id @default(uuid())
  templateId          String
  accountId           String
  descriptionTemplate String?
  debitAmount         Decimal                 @db.Decimal(18, 2)
  creditAmount        Decimal                 @db.Decimal(18, 2)
  lineOrder           Int

  template RecurringJournalTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  account  Account                  @relation(fields: [accountId], references: [id], onDelete: Restrict)

  @@index([templateId])
  @@index([accountId])
  @@unique([templateId, lineOrder])
}

model RecurringJournalGeneration {
  id                String                 @id @default(uuid())
  tenantId           String
  templateId        String
  generatedJournalId String
  runDate            DateTime
  generatedById      String
  createdAt          DateTime              @default(now())

  tenant           Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  template         RecurringJournalTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  generatedJournal JournalEntry            @relation("RecurringGeneratedJournal", fields: [generatedJournalId], references: [id], onDelete: Restrict)
  generatedBy      User                    @relation("RecurringJournalGeneratedBy", fields: [generatedById], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([tenantId, templateId])
  @@index([generatedJournalId])
  @@index([generatedById])
  @@unique([tenantId, templateId, runDate])
}

model AccountingPeriod {
  id         String                 @id @default(uuid())
  tenantId   String
  code       String?
  name       String
  startDate  DateTime
  endDate    DateTime
  type       AccountingPeriodType   @default(NORMAL)
  status     AccountingPeriodStatus @default(OPEN)
  createdById String?
  closedById String?
  closedAt   DateTime?
  createdAt  DateTime               @default(now())
  updatedAt  DateTime               @default(now()) @updatedAt

  tenant                     Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  createdBy                  User?                       @relation("AccountingPeriodCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  closedBy                   User?                       @relation("PeriodClosedBy", fields: [closedById], references: [id], onDelete: Restrict)
  fixedAssetDepreciationRuns FixedAssetDepreciationRun[]

  periodCloseChecklist PeriodCloseChecklist?

  checklistItems AccountingPeriodChecklistItem[]

  checklists AccountingPeriodChecklist[]

  closeLogs AccountingPeriodCloseLog[]

  reviewPacks ReviewPack[]

  disclosureNotes DisclosureNote[] @relation("DisclosureNotePeriod")

  budgetLines BudgetLine[]

  journals JournalEntry[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, type])
  @@index([tenantId, status])
  @@index([tenantId, startDate, endDate])
  @@index([createdById])
}

model DisclosureNote {
  id               String             @id @default(uuid())
  tenantId         String
  accountingPeriodId String
  noteType         DisclosureNoteType
  generatedAt      DateTime
  generatedById    String
  metadata         Json?
  createdAt        DateTime           @default(now())

  tenant           Tenant             @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  accountingPeriod AccountingPeriod   @relation("DisclosureNotePeriod", fields: [accountingPeriodId], references: [id], onDelete: Restrict)
  generatedBy      User               @relation("DisclosureNoteGeneratedBy", fields: [generatedById], references: [id], onDelete: Restrict)

  lines DisclosureNoteLine[]

  @@index([tenantId])
  @@index([tenantId, accountingPeriodId])
  @@index([tenantId, noteType])
  @@unique([tenantId, accountingPeriodId, noteType])
}

model DisclosureNoteLine {
  id               String         @id @default(uuid())
  disclosureNoteId String
  rowKey           String
  label            String
  values           Json
  orderIndex       Int

  disclosureNote DisclosureNote @relation(fields: [disclosureNoteId], references: [id], onDelete: Cascade)

  @@index([disclosureNoteId])
  @@unique([disclosureNoteId, rowKey])
  @@unique([disclosureNoteId, orderIndex])
}

model PeriodCloseChecklist {
  id        String   @id @default(uuid())
  tenantId  String
  periodId  String   @unique
  createdAt DateTime @default(now())

  tenant Tenant           @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  period AccountingPeriod @relation(fields: [periodId], references: [id], onDelete: Restrict)
  items  PeriodCloseChecklistItem[]

  @@unique([tenantId, periodId])
  @@index([tenantId])
  @@index([periodId])
}

model PeriodCloseChecklistItem {
  id            String                       @id @default(uuid())
  tenantId      String
  checklistId   String
  code          String
  name          String
  status        PeriodCloseChecklistItemStatus @default(PENDING)
  completedById String?
  completedAt   DateTime?
  createdAt     DateTime                     @default(now())

  tenant      Tenant              @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  checklist   PeriodCloseChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  completedBy User?               @relation("PeriodCloseChecklistItemCompletedBy", fields: [completedById], references: [id], onDelete: Restrict)

  @@unique([checklistId, code])
  @@index([tenantId])
  @@index([checklistId])
  @@index([completedById])
}

model JournalLine {
  id             String  @id @default(uuid())
  journalEntryId String
  accountId      String
  legalEntityId  String?
  departmentId   String?
  projectId      String?
  fundId         String?
  lineNumber     Int?
  description    String?
  debit          Decimal @default(0) @db.Decimal(18, 2)
  credit         Decimal @default(0) @db.Decimal(18, 2)

  journalEntry JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account      Account      @relation(fields: [accountId], references: [id], onDelete: Restrict)
  legalEntity  LegalEntity? @relation(fields: [legalEntityId], references: [id], onDelete: Restrict)
  department   Department?  @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  project      Project?     @relation(fields: [projectId], references: [id], onDelete: Restrict)
  fund         Fund?        @relation(fields: [fundId], references: [id], onDelete: Restrict)

  @@index([journalEntryId])
  @@index([accountId])
  @@index([legalEntityId])
  @@index([departmentId])
  @@index([projectId])
  @@index([fundId])
  @@index([journalEntryId, lineNumber])
}

model Budget {
  id           String       @id @default(uuid())
  tenantId     String
  fiscalYear   Int
  status       BudgetStatus @default(DRAFT)
  createdById  String
  approvedById String?
  createdAt    DateTime     @default(now())
  approvedAt   DateTime?

  tenant     Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  createdBy  User   @relation("BudgetCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  approvedBy User?  @relation("BudgetApprovedBy", fields: [approvedById], references: [id], onDelete: Restrict)

  revisions BudgetRevision[]
  lines     BudgetLine[]

  @@index([tenantId])
  @@index([tenantId, fiscalYear])
}

model BudgetRevision {
  id          String   @id @default(uuid())
  tenantId    String
  budgetId    String
  revisionNo  Int
  createdAt   DateTime @default(now())
  createdById String

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  budget    Budget @relation(fields: [budgetId], references: [id], onDelete: Restrict)
  createdBy User   @relation("BudgetRevisionCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)

  lines BudgetLine[]

  @@unique([budgetId, revisionNo])
  @@index([tenantId])
  @@index([tenantId, budgetId])
}

model BudgetLine {
  id         String   @id @default(uuid())
  tenantId   String
  budgetId   String
  revisionId String
  accountId  String
  periodId   String
  legalEntityId String?
  departmentId String?
  projectId String?
  fundId String?
  amount     Decimal  @db.Decimal(18, 2)
  createdAt  DateTime @default(now())

  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  budget   Budget          @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  revision BudgetRevision  @relation(fields: [revisionId], references: [id], onDelete: Cascade)
  account  Account         @relation(fields: [accountId], references: [id], onDelete: Restrict)
  period   AccountingPeriod @relation(fields: [periodId], references: [id], onDelete: Restrict)
  legalEntity LegalEntity? @relation(fields: [legalEntityId], references: [id], onDelete: Restrict)
  department Department? @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  project Project? @relation(fields: [projectId], references: [id], onDelete: Restrict)
  fund Fund? @relation(fields: [fundId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([tenantId, budgetId])
  @@index([accountId])
  @@index([periodId])
  @@index([budgetId, accountId])
  @@index([legalEntityId])
  @@index([departmentId])
  @@index([projectId])
  @@index([fundId])
  @@unique([revisionId, accountId, periodId, legalEntityId, departmentId, projectId, fundId])
}
